@model ClassRoom
@using System.Globalization;
@{
    Layout = "_Layout2";
    ViewData["Title"] = Model.Name + " - Classroom";
}

@section CSSSection {
    <style>
        .classroom-header {
            background: linear-gradient(90deg, @Model.Color 60%, #f8f9fa 100%);
            border-radius: 1rem;
            color: #fff;
            padding: 2rem 2rem 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        }

            .classroom-header h1 {
                font-size: 2.2rem;
                font-weight: 700;
            }

            .classroom-header .desc {
                font-size: 1.1rem;
                color: #f1f1f1;
            }

        .classroom-sidebar {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
        }

        .classroom-section {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
        }

            .classroom-section h3 {
                font-size: 1.3rem;
                font-weight: 600;
                margin-bottom: 1.2rem;
            }

        .class-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        .list-group-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: box-shadow 0.3s ease;
        }

            .list-group-item:hover {
                box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
                border-color: #ced4da;
            }

            .list-group-item i {
                color: #6c757d;
            }

            .list-group-item h5 {
                margin-bottom: 0;
                font-weight: 600;
            }

            .list-group-item span {
                color: #6c757d;
                font-size: 0.875rem;
            }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
        }
    </style>
}

<div class="container mt-4">
    <h1>@Model.Name</h1>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-target="content-stream">Akýþ</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-target="content-classwork">Sýnýf Çalýþmalarý</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-target="content-people">Kiþiler</a>
        </li>
    </ul>

    @if (!Model.IsActive)
    {
        <div class="card text-center fs-5 mb-4" style="background-color:#adb5bd">
            Ders, Öðretmeniniz tarafýndan arþivlendi. Herhangi bir ekleme veya düzenleme yapamazsýnýz.
        </div>
    }

    <div class="card mb-4 text-white" style="background-color:@Model.Color">
        <div class="card-body">
            <h2 class="card-title">@Model.Description</h2>
            <p class="card-text">@Model.ApplicationUser.Name @Model.ApplicationUser.Surname</p>
        </div>
        <div class="dropdown" style="margin-left:auto; margin-right: 0;">
            <button style="color:white" class="btn btn-link" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                @if (ViewBag.ApplicationUserRole && Model.IsActive)
                {
                    <li><a asp-action="ArchivedClassroom" asp-route-id="@Model.Id" class="dropdown-item">Arþivle</a></li>
                    <li><a asp-action="DeleteClassroom" asp-route-id="@Model.Id" class="dropdown-item">Sil</a></li>
                }
                else if (ViewBag.ApplicationUserRole && !Model.IsActive)
                {
                    <li><a asp-action="UnarchivedClassroom" asp-route-id="@Model.Id" class="dropdown-item">Arþivden çýkart</a></li>
                    <li><a asp-action="DeleteClassroom" asp-route-id="@Model.Id" class="dropdown-item">Sil</a></li>
                }
                @if (Model.ApplicationUser.Id != ViewBag.ApplicationUser && Model.IsActive)
                {
                    <li><a asp-action="UnenrollClassroom" asp-route-id="@Model.Id" class="dropdown-item">kaydý sil</a></li>
                }
            </ul>
        </div>
    </div>

    <div class="row">
        @if (Model.IsActive)
        {
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title" style="display:inline; margin-right: 10px;">Sýnýf Kodu:</h5>
                        <h5 class="card-title" style="display:inline;">@Model.UnicCode</h5>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <h4 class="card-title">Yaklaþan Çalýþmalar</h4>
                        <hr />
                        <p class="card-text">
                            @if (ViewBag.NearestHomework != null)
                            {
                                <h5>@ViewBag.NearestHomework.Name</h5>
                                <small class="text-muted ms-2">@ViewBag.NearestHomework.DueDate.ToString("dMMMM", CultureInfo.CreateSpecificCulture("en-US")) @ViewBag.NearestHomework.DueDate.ToString("HH:mm")</small>
                            }
                            else
                            {
                                <span>Yaklaþan Çalýþma yok</span>
                            }
                        </p>
                        <a id="viewAllButton" class="btn btn-outline-primary btn-sm">Tümünü Görüntüle</a>
                    </div>
                </div>
            </div>
        }
        <div class="col-md-9">
            <!-- Tab Content -->
            <div class="tab-content active" id="content-stream">
                @if (Model.IsActive)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Sýnýfýna bir duyuru yap</h5>
                            <form asp-action="Announcements" method="post" class="form">
                                <div class="input-group">
                                    <input type="hidden" name="classroomId" value="@Model.Id" />
                                    <input name="announcements" type="text" class="form-control" placeholder="Sýnýfýnýza duyuru yapýn" aria-label="Duyuru metni">
                                    <button class="btn btn-outline-secondary" type="submit">Gönder</button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                @foreach (var item in ViewBag.Announcements)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="class-avatar" style="background-color: #00008B;">@item.ApplicationUser.Name[0]</div>
                                    <h6 class="mb-0 ms-2">@item.ApplicationUser.Name @item.ApplicationUser.Surname</h6>
                                    <small class="text-muted ms-2">@(item.CreatedAt.ToString("yyyy-MM-dd") == DateTime.Now.ToString("yyyy-MM-dd") ? item.CreatedAt.ToString("HH:mm") : item.CreatedAt.ToString("dMMMM", CultureInfo.CreateSpecificCulture("en-US")))</small>
                                </div>
                                @if ((ViewBag.ApplicationUserRole || item.ApplicationUser.Id == ViewBag.ApplicationUser) && Model.IsActive)
                                {
                                    <div class="dropdown">
                                        <button class="btn btn-link" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                            <li><a asp-action="DeleteAnnonucements" asp-route-classroomId="@Model.Id" asp-route-announcementsId="@item.Id" class="dropdown-item">Sil</a></li>
                                        </ul>
                                    </div>
                                }
                            </div>
                            <p>@item.Contents</p>
                            <hr />
                            @{
                                bool hasComments = false;
                            }
                            @foreach (var comment in ViewBag.Comments)
                            {
                                if (comment.Announcements.Id == item.Id)
                                {
                                    hasComments = true;
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="class-avatar" style="background-color: #6c757d; width: 35px; height: 35px;">@comment.ApplicationUser.Name[0]</div>
                                        <div class="ms-3">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-0">@comment.ApplicationUser.Name @comment.ApplicationUser.Surname</h6>
                                                <small class="text-muted ms-2">@(comment.CreatedAt.ToString("yyyy-MM-dd") == DateTime.Now.ToString("yyyy-MM-dd") ? comment.CreatedAt.ToString("HH:mm") : comment.CreatedAt.ToString("dMMMM", CultureInfo.CreateSpecificCulture("en-US")))</small>
                                            </div>
                                            <p class="mb-0">@comment.Description</p>
                                        </div>
                                        @if ((ViewBag.ApplicationUserRole || item.ApplicationUser.Id == ViewBag.ApplicationUser || comment.ApplicationUserId == ViewBag.ApplicationUser) && Model.IsActive)
                                        {
                                            <div style="margin-left:auto; margin-right: 0;">
                                                <button class="btn btn-link" type="button">
                                                    <a asp-controller="Comment" asp-action="RemoveComment" asp-route-classroomId="@Model.Id" asp-route-AnnouncementId="@item.Id" asp-route-CommentId="@comment.Id" class="dropdown-item"><i class="fa-solid fa-xmark"></i></a>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                            @if (hasComments)
                            {
                                <hr />
                            }

                            @if (Model.IsActive)
                            {
                                <form asp-controller="Comment" asp-action="AddComment" asp-route-AnnouncementId="@item.Id" asp-route-ClassroomId="@Model.Id" class="form" method="post">
                                    <div class="d-flex align-items-center mt-3">
                                        <input name="description" type="text" class="form-control" placeholder="Sýnýfa yorum ekle...">
                                        <button type="submit" class="btn btn-link"><i class="fas fa-paper-plane"></i></button>
                                    </div>
                                </form>
                            }
                        </div>
                    </div>
                }
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Burasý sýnýfýnýzla konuþabileceðiniz yerdir</h5>
                        <p class="card-text">Duyuru paylaþmak, ödev yayýnlamak ve öðrenci sorularýna yanýt vermek için akýþý kullanýn</p>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="content-classwork">
                <div class="container">
                    @if (ViewBag.ApplicationUserRole && Model.IsActive)
                    {
                        <a asp-controller="Homework" asp-action="CreateHomework" asp-route-id="@Model.Id" class="btn btn-primary btn-lg mb-3"><i class="fa-solid fa-plus"></i> Oluþtur</a>
                    }
                    @if (ViewBag.Homeworks.Count != 0)
                    {
                        <h2 class="h3">Sýnýf Çalýþmalarý</h2>
                    }
                    else
                    {
                        <h2 class="h4">Bu sýnýfýn henüz herhangi bir sýnýf çalýþmasý yok.</h2>
                    }
                    <ul class="list-group">
                        @foreach (var item in ViewBag.Homeworks)
                        {
                            <a asp-controller="Homework" asp-action="@(ViewBag.ApplicationUserRole ? "HomeworkList" : "Index")" asp-route-ClassroomId="@Model.Id" asp-route-HomeworkId="@item.Id" style="text-decoration: none">
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fa-solid fa-pen m-3"></i>
                                <h5>@item.Name</h5>
                                <span style="margin-left:auto; margin-right:0;">Due @item.DueDate.ToString("dMMMM", CultureInfo.CreateSpecificCulture("en-US")) @item.DueDate.ToString("HH:mm")</span>
                            </li>
                            </a>
                        }
                    </ul>
                </div>
            </div>
            <div class="tab-content" id="content-people">
                <div class="container">
                    <h2 class="h3">Öðretmenler</h2>
                    <ul class="list-group mb-4">
                        @foreach (var item in ViewBag.Teachers)
                        {
                            <li class="list-group-item d-flex align-items-center mt-2">
                                <div class="avatar bg-success text-white me-3">@item.Name[0]</div>
                                <span>@item.Name @item.Surname</span>
                            </li>
                        }
                    </ul>
                    <h2 class="h3">Sýnýf Arkadaþlarý <small class="text-muted">(@ViewBag.Students.Count öðrenci)</small></h2>
                    <ul class="list-group">
                        @foreach (var item in ViewBag.Students)
                        {
                            <li class="list-group-item d-flex align-items-center mt-2">
                                <div class="avatar bg-danger text-white me-3">@item.Name[0]</div>
                                <span>@item.Name @item.Surname</span>
                                @if (ViewBag.ApplicationUserRole && Model.IsActive)
                                {
                                    <div class="dropdown" style="margin-left:auto; margin-right: 0;">
                                        <button class="btn btn-link" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                            <li><a asp-action="MakeTeacher" asp-route-userId="@item.Id" asp-route-classroomId="@Model.Id" class="dropdown-item">Öðretmen yap</a></li>
                                            <li><a asp-action="RemoveStudent" asp-route-userId="@item.Id" asp-route-classroomId="@Model.Id" class="dropdown-item">Kaldýr</a></li>
                                        </ul>
                                    </div>
                                }
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

   

    <button type="button" class="btn btn-primary" onclick="embedStackBlitz()">StackBlitz Editörü Aç</button>
    <div id="stackblitz-embed" style="height:500px;width:100%;border:1px solid #ccc;margin-top:2rem; display:none;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Sekme deðiþtirme iþlevselliði
    document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelectorAll('.nav-tabs .nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetId = this.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) target.classList.add('active');
        });
    });

    // "Tümünü Görüntüle" butonu
    const viewAllButton = document.getElementById('viewAllButton');
    if (viewAllButton) {
        viewAllButton.addEventListener('click', function () {
            const classworkTab = document.querySelector('.nav-link[data-target="content-classwork"]');
            if (classworkTab) {
                classworkTab.click();
            }
        });
    }

    // StackBlitz editörünü açan fonksiyon
    function embedStackBlitz() {
        const embedDiv = document.getElementById('stackblitz-embed');
        embedDiv.innerHTML = '<iframe src="https://stackblitz.com/edit/web-platform?embed=1&file=index.html" style="width:100%;height:100%;border:none;border-radius:8px;"></iframe>';
        embedDiv.style.display = 'block';
    }

   
</script>